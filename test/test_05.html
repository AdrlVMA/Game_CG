<html>
    <head>
<!--    https://github.com/n5ro/aframe-physics-system/blob/master/AmmoDriver.md    -->
<!--    https://stackoverflow.com/questions/66423513/how-to-move-a-dynamic-body-with-a-frame-physics-system-when-using-ammo-driver    -->
        <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
        <script src="https://mixedreality.mozilla.org/ammo.js/builds/ammo.wasm.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/n5ro/aframe-physics-system@v4.0.1/dist/aframe-physics-system.js"></script>

        <script src="https://unpkg.com/aframe-event-set-component@4.2.1/dist/aframe-event-set-component.min.js"></script>
        <script src="https://unpkg.com/super-hands@2.1.0/dist/super-hands.min.js"></script>
        <script src="https://cdn.rawgit.com/donmccurdy/aframe-extras/v3.13.1/dist/aframe-extras.min.js"></script>
        <script>
            AFRAME.registerComponent("moving-dynamic-body", {
                init: function() {
                    // wait until the physics engine is ready
                    this.el.addEventListener("body-loaded", e => {
                        // cache the ammo-body component
                        this.ammoComponent = this.el.components["ammo-body"];
                        // use this vector to zero the velocity
                        // keep in mind this needs to be deleted manually from the memory with Ammo.destroy(this.zeroSpeed)
                        this.zeroSpeed = new Ammo.btVector3(0, 0, 0);
                    });
                },
                tick: function() {
                    // wait for the physics
                    if (!this.ammoComponent) return;

                    // restore stuff if the "teleport magic" has been done in the last renderloop.
                    // this should probably be done in steps instead of tick
                    if (this.collisionFlag === 2) {
                        // this just tells us that we reverted to normal
                        this.collisionFlag = 0;
                        // restore the original collision flags
                        this.ammoComponent.updateCollisionFlags();
                        // reset the speed, or the body will bounce away
                        this.ammoComponent.body.setLinearVelocity(this.zeroSpeed);
                    }

                    // if the body is below 1m
                    // if (this.el.object3D.position.y < 3) {
                    //     // set the THREEJS position.y
                    //     this.el.object3D.position.x += 0.02;
                    //     // change the collision flag to the KINEMATIC_BODY
                    //     this.collisionFlag = 2;
                    //     // apply the flag
                    //     this.ammoComponent.body.setCollisionFlags(this.collisionFlag);
                    //     // sync the physisc transforms to the THREEJS transform
                    //     this.ammoComponent.syncToPhysics();
                    // }
                }
            });
        </script>
    </head>
    <body>
        <a-scene physics="driver: ammo; debug: true; debugDrawMode: 1; gravity: -9.8" renderer="colorManagement:true">

            <a-camera position="0 1 0" wasd-controls="enabled: false" look-controls="enabled: false">

            <!--  Progressive controls  -->
            <a-entity progressive-controls position="0 0 5">
            </a-entity>

            <!--  Green sphere  -->
            <a-sphere color="#00AA00" radius="0.5" position="1 1 -4"
                      ammo-body="type: static" ammo-shape="type: sphere">
            </a-sphere>

            <!--  Yellow sphere  -->
            <a-sphere color="#FFAA00" radius="0.5" position="1 4 -4" moving-dynamic-body
                      ammo-body="type: dynamic" ammo-shape="type: sphere" height="0.1" width="0.1" depth="0.1">
            </a-sphere>

            <!--  Ground  -->
            <a-plane src="#ground" scale="50 50 1" rotation="-90 0 0"
                     ammo-body="type: static" ammo-shape="type: box">
                <img id="ground" src="./floor2.jpg">
            </a-plane>
        </a-scene>
    </body>
</html>
